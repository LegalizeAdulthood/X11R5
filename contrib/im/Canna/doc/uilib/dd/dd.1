


 ┌────────────────────────┐
 │ＵＩライブラリ詳細仕様書			   │
 └────────────────────────┘

                                                                                                  ──  目次  ──

 １  ＵＩライブラリの機能概要とア−キテクチャ  ─────────────
 ２  jrKanjiString 又はXLookupKanjiString処理概要  ───────────
 ３  jrKanjiControl又はXKanjiControl の処理概要  ────────────
 ４  カスタマイズ指定とライブラリの関係  ────────────────


１．ＵＩライブラリの機能概要とア−キテクチャ

  jrKanjiControl、XKanjiControl 、jrKanjiStringo及び
  XLookupKanjilString を総称してＵＩライブラリという。ＵＩライブラリは、
  アプリケ−ションからキ−を受け取るとそれを解釈し、Rkライブラリの関数
  を必要に応じて呼び出し中間結果表示用デ−タを返す。以下にアプリケ−ショ
  ン、ＵＩライブラリ及びＲｋライブラリの全体構造及び関係を示す。


全体構造
      ┌─────┐
      │  ＡＰ    │
      ├─────┤
      │ＵＩ Lib  │
      ├─────┤
      │ Rk  Lib  │
      └─────┘

                               キー
 ┌────┐    ┌─────┐context ID┌────┐context ID┌────┐
 │        │    │          │────→│        │────→│        │
 │KEY 入力│─→│アプリ    │          │ UI Lib │          │ Rk Lib │
 │        │    │ケーション│←────│        │←────│        │
 └────┘    └─────┘中間結果  └────┘変換data等└────┘
                   │
                   │
                   ↓
              ┌─────┐
	      │          │
 	      │  表示    │
 	      │          │
	      └─────┘


 （動作例）

    ┌────┬────────┬──────────────┐
    │キ−入力│UI Lib 中間結果 │          Rk Lib            │
    ├────┼────────┼──────────────┤
    │  w     │    "w"         │                            │
    │  a     │    " わ"       │                            │
    │  t     │    " わt"      │                            │
    │  a     │    " わた"     │                            │
    │  s     │    " わたs"    │                            │
    │  i     │    " わたし"   │                            │
    │(space) │                │・RkBgnBun（変換開始）      │
    │        │                │       :                    │
    │        │                │       :                    │
    │        │    " 私"       │・RkGetKanji（候補取り出し）│
    └────┴────────┴──────────────┘


２．jrKanjiString 又はXLookupKanjiString処理概要

  この章は、ＵＩライブラリに対してアプリケ−ションから１つのキ−が渡さ
  れたとき、どのように 動作するかを記述したものである。

２．１  １キ−による１機能の処理

  (1)アプリケ−ションから渡されたコンテキスト番号（JrkanjiString ）又
  は、ディスプレイ、ウインドウの組（XLookupKanjiString）により、ハッシュ
  キ−を作成し、ハッシュテ−ブルからuiContext を得る。


                                            同じハッシュキ−
                                          ┌────────┐
      ハッシュテ−ブル                    │                │
  ┌─┌──────┐      ┌─→┌─────┐    ┌─→┌─────┐
  │  │            │───┘    │          │──┘    │          │
  │  ├──────┤        ┌─└─────┘      ┌─└─────┘
  │  │            │──┐  │                      │
  96  ├──────┤    │  └→┌─────┐      └→┌─────┐
  │  ├──────┤    │      │          │          │          │
  │  ├──────┤    │      │          │          │          │
  │  │      :     │    │      │          │          │          │
  │  │      :     │    │      │          │          │          │
  └─└──────┘    │      └─────┘          └─────┘
                          │        uiContext               uiContext
                          │
                          └──→┌─────┐
                                  │          │
                              ┌─└─────┘
                              │
                              └→┌─────┐
                                  │          │
                                  │          │
                                  │          │
                                  │          │
                                  └─────┘
                                    uiContext

  １つのアプリケ−ションプログラムで、複数のウインドウを開いて同時にか
  な漢字変換を行う場合、複数のかな漢字変換の状態を管理しなければならな
  い。

  ＵＩライブラリは、かな漢字変換の数だけuiContext を作ることによって複
  数のかな漢字変換の状態を管理する。

  また、どのuiContext を使うかはアプリケ−ションプログラムからの情報に
  よって決められる。

  (2)アプリケ−ションプログラムからjrKanjistring 又は
  XLookupKanjiStringに対し文字列返却の為に渡されたバッファ等のアドレス
  をuiContext に記録する。

  (3)uiContext からカレントモ−ド構造体を得る。


  uiContext
 ┌──────┐          構造体       読み入力中であればyomimap.c 中にある
 ├──────┤  ┌→┌──────┐ yomi_mode 、また候補一覧表示中であれ
 │current_mode│─┘  │ simplefunc │ ばichiranmap.c中にあるichiran_modeが
 ├──────┤      ├──────┤ カレントモ−ド構造体として得られる。
 │     :      │      │キーテーブル│
 │     :      │      ├──────┤
 └──────┘      │   フラグ   │
                       ├──────┤
                       │関数テーブル│
                       └──────┘

  モ−ド構造体とは、現在のモ−ドにおけるキ−の振るまいを管理している構
  造体である。入力されたキ−に対応してどのような機能が呼び出されるかは、
  モ−ド構造体に記録してある。

  (4)モ−ド構造体中のsimplefuncを実行する。

  (5)simplefuncではモ−ド構造体中のキ−テ−ブルを参照し、入力された
     キ−の機能を得る。
     ─────
         │
         └─────────────────────┐
					 	     │
    モード構造体                                     │
  ┌──────┐       キーテーブル		     │
  │ simplefunc │  ┌→┌──────┐             │
  ├──────┤  │  │            │─┐         ↓
  │キーテーブル│─┘  ├──────┤  ├─IROHA_FN_Backward など
  ├──────┤      │            │  │  番号として情報が入っている。
  │   フラグ   │      ├──────┤  │
  ├──────┤      │            │  │         │
  │関数テーブル│─┐  ├──────┤  │         │
  └──────┘  │  │      :     │  │         │
                    │  │      :     │─┘         │
                    │  └──────┘             │
                    │                               │
                    │    関数テーブル               │
                    └→┌──────┐             │
                        │            │─┐
                        ├──────┤  ├─処理関数ポインタが入っている。
                        │            │  │
                        ├──────┤  │
                        │      :     │  │
                        │      :     │─┘
                        └──────┘

  (6)モ−ド構造体中の関数テ−ブルをキ−の機能で参照し、処理関数へのポ
  インタを得る。

  (7)(6)で求めた処理関数を呼び出す。かな漢字変換や文節の移動は処理関数
  として定義されている。この処理関数の呼び出しが全体の処理の中心的な処
  理である。

  (8)コ−ルバック関数を呼び出す。コ−ルバック関数とは、(7)で実行された
  処理関数の後処理として呼び出される関数であり、各モ−ドに依存した処理
  を行う。

  例えば、候補一覧行表示中にカレント候補が変化するようなキ−（→、←等）
  が渡された場合は、毎回中間結果を返さなくてはならない。このようなとき
  は、コ−ルバック構造体の everytime （処理中）関数が呼ばれるように
  UiContext のstatusを設定する。またコ−ルバック関数という考え方は次の
  ような処理の為にある。例えば、読みを入力すると言っても通常の読みを入
  力する場合、編集モ−ドで読みを入力する場合、あるいは部首読み入力をす
  る場合などいろいろなモ−ドで発生する。このとき渡されたキ−（１文字）
  を読み情報に挿入する処理等は同一である。しかし、アプリケ−ションへの
  中間結果の返し方はそれぞれ異なる。このモ−ドによって異なる部分をコ−
  ルバック関数として用意すれば、読み入力処理の中心的な部分は同一の関数
  で処理することが出来る。

   UiContext
  ┌─────┐
  │    :     │
  │    :     │
  ├─────┤
  │  status  │──────────────┐
  ├─────┤         callback構造体     │
  │    cb    │───→┌─────┐      │statusによって参照される。
  ├─────┤        │everytime │─┐  │
  │    :     │        ├─────┤  │←┘
  ├─────┤        │   exit   │  │
  │more.todo │        ├─────┤  │各コ−ルバック関数へのポインタ
  ├─────┤        │   quit   │  │
  │    :     │        ├─────┤  │    0 : everytime : 処理中
  └─────┘        │   AUX    │─┘    1 : exit      : 処理終了
                        ├─────┤        2 : quit      : 処理中止
                        │    :     │        3 : AUX       : その他
                        ├─────┤
                        │    :     │
                        └─────┘

  (9)uiContext 中のmore.todo がＵＩライブラリによって指定されていれば
  それを実行する。(1)〜(8)まででアプリケ−ションから渡されたキ−に対す
  る処理は終了するが、さらにキ−入力があるようにするための処理である。
  例えば、かな漢字変換中に文節を確定するキ−が渡された場合　銑┐任修
  処理を行うが、カスタマイズファイルにStayAfterValidate off と指定して
  あれば、さらに次文節に移動する処理を行わなくてはならない。このような
  ときに、ＵＩライブラリがmore.todo に次文節に移動する機能 
  (IROHA_FN_Forward) を指定する。
