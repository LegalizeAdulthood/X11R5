かな漢字変換処理中にも、必要に応じて現在のモードを調べたり、
かな漢字変換中の文字を強制的にアプリケーションプログラム側から
確定させたりすることが可能です。

それぞれの機能は jrKanjiControl を対応するコントロールキーワードを伴っ
て呼び出すことにより実行されます。
実行できる機能には以下のものがあります。

\begin{tabular}{|c|l|l|l|}\hline
& キーワード & 処理内容 & 備考 \\
\hline\hline
1 & KC\_QUERYMODE & モードの調査 & \\
2 & KC\_CHANGEMODE & モードの変更 & \\
3 & KC\_KAKUTEI & 入力中の文字列の確定 & \\
4 & KC\_KILL & 入力中の文字列の消去 & \\
5 & KC\_SETUNDEFKEYFUNCTION & 未定義キーの処理 & \\
6 & KC\_CLOSEUICONTEXT & 入力コンテクストのクローズ & \\
\hline\end{tabular}

以下ではそれぞれの機能に対応するコントロールキーワードと、その使い方な
どについて説明します。詳細なアプリケーションインタフェース仕様に付いて
はjrKanjiControlの説明の項を参照して下さい。

\subsection{モードの調査}

現在の入力モードが何であるのかを前述した KC\_QUERYMODE で調べることがで
きます。ただし、以下の理由からKC\_QUERYMODEの呼び出しだけでは今どのよう
なモードであるのか断定することができません。

\begin{enumerate}
  \item KC\_QUERYMODE の返す値はデフォルトではモード文字列の形
        である
  \item モード文字列はユーザのカスタマイズにより変更できる
\end{enumerate}

実は、KC\_SETMODEINFOSTYLE によって KC\_QUERYMODE の返す値を調査用にちょっ
と変更することができます。KC\_SETMODEINFOSTYLE ではモードとしてどのよう
なものを採用するかを制御できます。

\begin{tabular}{|c|c|c|}\hline
SETMODEINFOSTYLEに与える値 & 0 & 1\\
\hline
表示されるモード & 文字列 & 数値+'@'(0x40)\\
\hline\end{tabular}

KC\_SETMODEINFOSTYLE でモードスタイルを１にす
ることによりKC\_QUERYMODEで返される値はモードを表す数値に'@'(0x40)を足
した値が１文字長の文字列として返されるようになります。この値はユーザに
よるカスタマイズの影響を受けません。モードを表す数値とはヘッダファイル
$<$iroha/jrkanji.h$>$から間接的にインクルードされる$<$iroha/mfdef.h$>$
の中で、IROHA\_MODE\_×××としてマクロ定義されている値です。
例えばアルファベットモードはIROHA\_MODE\_AlphaModeというマクロで定義され
る値を持ちます。

KC\_QUERYMODEによって返される値から'@'を引いたものを
IROHA\_MODE\_AlphaModeなどと比較することにより現在のモードを明確に判断
することができます。

\subsection{モードの変更}

アプリケーションプログラムの都合でかな漢字変換のモードを例えばカタカナ
入力モードなどに強制的に変更する場合にはKC\_CHANGEMODEを用います。

\subsection{入力中の文字列の確定/消去}

何らかの都合で入力中の文字列をアプリケーションプログラム側から
消去したり確定したりしたいことがあると思います。

例えば、ダイアログボックスを表示していた場合、Cancelボタンなどがクリッ
クされた時はそのダイアログボックス中の全ての入力ポートに対して入力状態
をクリアする処理をする必要があります。

このような場合にはKC\_KAKUEIあるいはKC\_KILLを行います。

それぞれの意味は以下のようになります。

\begin{tabular}{|l|l|}\hline
KC\_KAKUTEI & 入力中の文字を強制的に確定させる\\
KC\_KILL & 入力中の文字を強制的に消去する\\
\hline\end{tabular}

いずれの場合もかな漢字変換の状態は
基底状態(何も入力されていない状態)になります。
\subsection{未定義キーの処理}

かな漢字変換中にかな漢字変換には用いられないキー(未定義キー)が
入力された時の処理を
指定することができます。デフォルトでは未定義キーは単に無視されるだけで
すが、以下のように設定することができます。

\begin{enumerate}
  \item ビープ音を鳴らす
  \item 未定義キーをアプリケーションプログラムに渡す。

この場合、以下の３つのうちのいずれかを選択できます。

  \begin{enumerate}
    \item 入力中の文字列を確定する。
    \item 入力中の文字列を消去する。
    \item 入力中の文字列は入力中のままにしておく。
  \end{enumerate}
\end{enumerate}

\subsection{入力コンテクストのクローズ}

ユーザインタフェースライブラリを用いてかな漢字変換を行う上ではさまざま
な形でメモリを消費します。

例えば入力ポートが増えればその分だけ余分にメモリを消費することになりま
す。

入力にウィンドウを用いるアプリケーションプログラムによっては入力のため
のウィンドウを次々と作っては壊して行く場合があります。
このような場合にjrKanjiStringに対して
次々と新しいコンテクストを与えて行
くとどんどんメモリを消費してしまうことになります。

入力に用いられたウィンドウを破壊する場合にはそのウィンドウからの
入力をjrKanjiStringに与える時に用いていたコンテクストを
クローズをした方が良いでしょう。

コンテクストをクローズすることにより、その入力コンテクストのために確保
されていたメモリが解放されます。

コンテクストの解放にはKC\_CLOSEUICONTEXTを用います。
